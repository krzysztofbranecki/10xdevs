---
import Layout from "../layouts/Layout.astro";
import PageWrapper from "../components/common/PageWrapper.astro";

// Dostęp do danych użytkownika
const { user } = Astro.locals;

// Skrypt do obsługi generowania fiszek
const generateScript = `
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.querySelector("form");
    const errorDiv = document.querySelector('[data-test="generate-error"]');
    const successDiv = document.querySelector('[data-test="generate-success"]');
    const resultContainer = document.querySelector('[data-test="flashcards-result"]');
    const loadingIndicator = document.querySelector('[data-test="loading-indicator"]');

    if (form && errorDiv && successDiv && resultContainer && loadingIndicator) {
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        
        // Ukrywamy komunikaty i pokazujemy ładowanie
        errorDiv.classList.add("hidden");
        successDiv.classList.add("hidden");
        resultContainer.classList.add("hidden");
        loadingIndicator.classList.remove("hidden");

        const formData = new FormData(form);
        const content = formData.get("content");
        const language = formData.get("language");
        const count = formData.get("count");
        
        // Walidacja po stronie klienta
        if (!content) {
          errorDiv.textContent = "Treść jest wymagana";
          errorDiv.classList.remove("hidden");
          loadingIndicator.classList.add("hidden");
          return;
        }
        
        try {
          // W przyszłości zostanie zastąpione rzeczywistym endpointem API
          // Symulacja odpowiedzi API
          setTimeout(() => {
            loadingIndicator.classList.add("hidden");
            
            // Przykładowe dane fiszek
            const mockData = {
              flashcards: [
                { front: "Apple", back: "Jabłko" },
                { front: "Book", back: "Książka" },
                { front: "Computer", back: "Komputer" }
              ]
            };
            
            // Wyświetlanie wygenerowanych fiszek
            resultContainer.innerHTML = '';
            mockData.flashcards.forEach(card => {
              const cardElement = document.createElement("div");
              cardElement.className = "bg-gradient-to-br from-white/10 to-white/5 backdrop-blur-lg rounded-xl p-4 border border-white/10 mb-4";
              cardElement.innerHTML = \`
                <div class="flex justify-between mb-2">
                  <div class="font-medium text-blue-200">\${card.front}</div>
                  <div class="text-purple-200">\${card.back}</div>
                </div>
                <div class="flex justify-end mt-2">
                  <button class="text-xs bg-blue-500/30 hover:bg-blue-500/50 px-2 py-1 rounded-md text-blue-100 transition-colors">
                    Edytuj
                  </button>
                </div>
              \`;
              resultContainer.appendChild(cardElement);
            });
            
            resultContainer.classList.remove("hidden");
            successDiv.textContent = "Pomyślnie wygenerowano fiszki!";
            successDiv.classList.remove("hidden");
          }, 1500);
          
        } catch (error) {
          console.error("Generation error:", error);
          errorDiv.textContent = "Wystąpił błąd podczas generowania fiszek";
          errorDiv.classList.remove("hidden");
          loadingIndicator.classList.add("hidden");
        }
      });
    }
  });
`;
---

<Layout title="Generator fiszek">
  <PageWrapper title="Generator fiszek" description="Twórz fiszki automatycznie na podstawie tekstu">
    <div class="flex justify-end mb-6">
      <p class="text-blue-100/80 mr-4">
        Zalogowano jako: <span class="text-blue-200 font-medium">{user?.email || "Gość"}</span>
      </p>
      <form method="POST" action="/api/auth/logout">
        <button
          type="submit"
          class="px-3 py-1.5 bg-red-600/80 hover:bg-red-600 text-white rounded-lg transition-colors text-sm"
        >
          Wyloguj się
        </button>
      </form>
    </div>

    <form class="space-y-6">
      <div
        data-test="generate-error"
        class="hidden text-red-500 text-sm font-medium mb-4 p-3 bg-red-100/10 border border-red-500/20 rounded"
      >
      </div>

      <div
        data-test="generate-success"
        class="hidden text-green-500 text-sm font-medium mb-4 p-3 bg-green-100/10 border border-green-500/20 rounded"
      >
      </div>

      <div class="space-y-2">
        <label for="content" class="block text-sm font-medium text-blue-100">Treść do przetworzenia</label>
        <div class="relative group">
          <textarea
            id="content"
            name="content"
            rows="6"
            placeholder="Wklej tutaj tekst, z którego chcesz wygenerować fiszki..."
            class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-200/60 focus:outline-none focus:border-blue-300/50 focus:ring-2 focus:ring-blue-500/30 transition-all duration-200 group-hover:border-white/30"
            required></textarea>
          <div
            class="absolute inset-0 rounded-lg bg-gradient-to-r from-blue-500/20 to-purple-500/20 opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity duration-300 blur-sm"
          >
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="space-y-2">
          <label for="language" class="block text-sm font-medium text-blue-100">Język docelowy</label>
          <div class="relative group">
            <select
              id="language"
              name="language"
              class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:border-blue-300/50 focus:ring-2 focus:ring-blue-500/30 transition-all duration-200 group-hover:border-white/30"
            >
              <option value="pl" class="bg-gray-800">Polski</option>
              <option value="en" class="bg-gray-800">Angielski</option>
              <option value="de" class="bg-gray-800">Niemiecki</option>
              <option value="es" class="bg-gray-800">Hiszpański</option>
              <option value="fr" class="bg-gray-800">Francuski</option>
            </select>
            <div
              class="absolute inset-0 rounded-lg bg-gradient-to-r from-blue-500/20 to-purple-500/20 opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity duration-300 blur-sm"
            >
            </div>
          </div>
        </div>

        <div class="space-y-2">
          <label for="count" class="block text-sm font-medium text-blue-100">Liczba fiszek</label>
          <div class="relative group">
            <input
              id="count"
              name="count"
              type="number"
              min="5"
              max="50"
              value="10"
              class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:border-blue-300/50 focus:ring-2 focus:ring-blue-500/30 transition-all duration-200 group-hover:border-white/30"
            />
            <div
              class="absolute inset-0 rounded-lg bg-gradient-to-r from-blue-500/20 to-purple-500/20 opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity duration-300 blur-sm"
            >
            </div>
          </div>
        </div>
      </div>

      <button
        type="submit"
        class="w-full py-3.5 px-4 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white text-lg rounded-lg font-medium transition-all duration-300 shadow-lg hover:shadow-blue-500/20 hover:shadow-xl transform hover:-translate-y-0.5 active:translate-y-0 mt-2"
      >
        Generuj fiszki
      </button>
    </form>

    <div data-test="loading-indicator" class="hidden mt-8 flex justify-center items-center">
      <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
      <span class="ml-3 text-blue-200">Generowanie fiszek...</span>
    </div>

    <div data-test="flashcards-result" class="mt-8 hidden space-y-4">
      <h2 class="text-xl font-semibold text-transparent bg-clip-text bg-gradient-to-r from-blue-200 to-purple-200 mb-4">
        Wygenerowane fiszki
      </h2>
      <!-- Tutaj będą dynamicznie generowane fiszki przez JavaScript -->
    </div>

    <div class="mt-8 flex justify-center">
      <a href="/collections" class="text-blue-200 hover:text-blue-100 transition-colors font-medium hover:underline">
        Przejdź do moich kolekcji fiszek
      </a>
    </div>
  </PageWrapper>
</Layout>

<!-- Renderowanie skryptu używając set:html -->
<script set:html={generateScript} />
